
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>新卒応募ダッシュボード | SARUCREW</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap');

  :root {
    --bg: #f7f5f0;
    --surface: #ffffff;
    --surface2: #f0ede6;
    --border: #e2ddd4;
    --accent: #c8522a;
    --text: #1a1714;
    --text-muted: #7a7167;
    --text-dim: #a09890;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
    opacity: 0.5;
  }

  .container {
    max-width: 1080px;
    margin: 0 auto;
    padding: 40px 32px;
    position: relative;
    z-index: 1;
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 48px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .header-left h1 {
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -0.03em;
    line-height: 1.1;
  }

  .header-left h1 em {
    font-style: normal;
    color: var(--accent);
  }

  .header-left p {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
    font-family: 'DM Mono', monospace;
    letter-spacing: 0.05em;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .last-updated {
    font-size: 11px;
    color: var(--text-dim);
    font-family: 'DM Mono', monospace;
  }

  .btn {
    padding: 9px 18px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    border: none;
    font-family: 'Noto Sans JP', sans-serif;
    transition: all 0.15s;
  }

  .btn-ghost {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-muted);
  }
  .btn-ghost:hover { color: var(--text); border-color: var(--text-dim); }

  .stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 28px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px 28px 24px;
    animation: fadeUp 0.5s ease both;
  }

  .stat-card:nth-child(1) { animation-delay: 0.05s; }
  .stat-card:nth-child(2) { animation-delay: 0.1s; }
  .stat-card:nth-child(3) { animation-delay: 0.15s; }

  .stat-card.featured {
    background: var(--accent);
    border-color: var(--accent);
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .stat-label {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 12px;
  }

  .stat-card.featured .stat-label { color: rgba(255,255,255,0.7); }

  .stat-value {
    font-size: 52px;
    font-weight: 700;
    font-family: 'DM Mono', monospace;
    line-height: 1;
    color: var(--text);
    letter-spacing: -0.03em;
  }

  .stat-card.featured .stat-value { color: white; }

  .stat-unit {
    font-size: 18px;
    font-weight: 400;
    color: var(--text-muted);
    margin-left: 4px;
  }

  .stat-card.featured .stat-unit { color: rgba(255,255,255,0.6); }

  .stat-sub {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 10px;
    font-family: 'DM Mono', monospace;
  }

  .stat-card.featured .stat-sub { color: rgba(255,255,255,0.5); }

  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    animation: fadeUp 0.5s ease 0.2s both;
  }

  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 28px;
  }

  .chart-title {
    font-size: 15px;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .tab-group {
    display: flex;
    background: var(--surface2);
    border-radius: 8px;
    padding: 3px;
    gap: 2px;
  }

  .tab {
    padding: 6px 16px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    color: var(--text-muted);
    border: none;
    background: transparent;
    font-family: 'Noto Sans JP', sans-serif;
    transition: all 0.2s;
  }

  .tab.active {
    background: var(--surface);
    color: var(--text);
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }

  .chart-wrap {
    height: 280px;
    position: relative;
  }

  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 280px;
    color: var(--text-muted);
    font-size: 13px;
    gap: 10px;
    flex-direction: column;
  }

  .spinner {
    width: 28px; height: 28px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .error-box {
    background: #fef2f0;
    border: 1px solid #fcc;
    border-radius: 10px;
    padding: 16px 20px;
    font-size: 13px;
    color: #c0392b;
    margin-top: 12px;
    display: none;
    line-height: 1.6;
  }

  @media (max-width: 640px) {
    .stats-row { grid-template-columns: 1fr; }
    .container { padding: 24px 16px; }
    header { flex-direction: column; align-items: flex-start; gap: 16px; }
    .stat-value { font-size: 40px; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-left">
      <h1>新卒<em>応募</em>ダッシュボード</h1>
      <p>SARUCREW · Notion DB連携</p>
    </div>
    <div class="header-right">
      <span class="last-updated" id="last-updated">読み込み中...</span>
      <button class="btn btn-ghost" onclick="loadData()">↻ 更新</button>
    </div>
  </header>

  <div class="stats-row">
    <div class="stat-card featured">
      <div class="stat-label">昨日の応募</div>
      <div class="stat-value" id="today-count">—<span class="stat-unit">件</span></div>
      <div class="stat-sub" id="today-date">—</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">今月の応募</div>
      <div class="stat-value" id="month-count">—<span class="stat-unit">件</span></div>
      <div class="stat-sub" id="month-label">—</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">累計応募</div>
      <div class="stat-value" id="total-count">—<span class="stat-unit">件</span></div>
      <div class="stat-sub">全期間合計</div>
    </div>
  </div>

  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">応募数推移</div>
      <div class="tab-group">
        <button class="tab active" onclick="switchTab('daily', this)">日別（30日）</button>
        <button class="tab" onclick="switchTab('monthly', this)">月別</button>
      </div>
    </div>
    <div class="chart-wrap">
      <div class="loading" id="chart-loading">
        <div class="spinner"></div>
        <span>Notionからデータ取得中...</span>
      </div>
      <canvas id="myChart" style="display:none;"></canvas>
    </div>
    <div class="error-box" id="error-box"></div>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwt0uV5yH5uOv6HGngANmOexMHB0Ta0f5LnYt0KiDbzIT9dNGGhUL3Iw2YKAZXIW9Sp/exec';
const DATE_FIELD = '応募日';
const STATUS_FIELD = 'ステータス';

let chart = null;
let allData = [];
let currentTab = 'daily';

async function fetchAllPages() {
  const res = await fetch(GAS_URL);
  if (!res.ok) throw new Error(`取得エラー: ${res.status}`);
  const data = await res.json();
  if (!Array.isArray(data)) throw new Error('データ形式が正しくありません');
  return data;
}

function getDateValue(page) {
  const props = page.properties;
  const f = props[DATE_FIELD];
  if (f) {
    if (f.type === 'date' && f.date) return f.date.start;
    if (f.type === 'rich_text' && f.rich_text?.[0]) return f.rich_text[0].plain_text;
    if (f.type === 'created_time') return f.created_time;
  }
  return page.created_time || null;
}

function hasStatus(page) {
  const props = page.properties;
  const f = props[STATUS_FIELD];
  if (!f) return true;
  if (f.type === 'select') return !!f.select;
  if (f.type === 'status') return !!f.status;
  if (f.type === 'rich_text') return f.rich_text?.length > 0;
  if (f.type === 'multi_select') return f.multi_select?.length > 0;
  return true;
}

function renderStats(pages) {
  const filtered = pages.filter(hasStatus);
  const today = new Date().toISOString().slice(0, 10);
  const yesterdayDate = new Date();
  yesterdayDate.setDate(yesterdayDate.getDate() - 1);
  const yesterday = yesterdayDate.toISOString().slice(0, 10);
  const monthPrefix = today.slice(0, 7);
  let todayCount = 0, monthCount = 0;

  filtered.forEach(p => {
    const d = getDateValue(p);
    if (!d) return;
    const ds = d.slice(0, 10);
    if (ds === yesterday) todayCount++;
    if (ds.startsWith(monthPrefix)) monthCount++;
  });

  document.getElementById('today-count').innerHTML = `${todayCount}<span class="stat-unit">件</span>`;
  document.getElementById('month-count').innerHTML = `${monthCount}<span class="stat-unit">件</span>`;
  document.getElementById('total-count').innerHTML = `${filtered.length}<span class="stat-unit">件</span>`;

  const now = new Date();
  document.getElementById('today-date').textContent =
    yesterdayDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
  document.getElementById('month-label').textContent =
    now.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
}

function renderChart(pages, mode) {
  document.getElementById('chart-loading').style.display = 'none';
  document.getElementById('myChart').style.display = 'block';

  const filtered = pages.filter(hasStatus);
  const counts = {};

  filtered.forEach(p => {
    const d = getDateValue(p);
    if (!d) return;
    const key = mode === 'daily' ? d.slice(0, 10) : d.slice(0, 7);
    counts[key] = (counts[key] || 0) + 1;
  });

  let labels, data;

  if (mode === 'daily') {
    const days = [];
    for (let i = 29; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      days.push(d.toISOString().slice(0, 10));
    }
    labels = days.map(d => {
      const [, m, day] = d.split('-');
      return `${parseInt(m)}/${parseInt(day)}`;
    });
    data = days.map(d => counts[d] || 0);
  } else {
    const keys = Object.keys(counts).sort();
    labels = keys.map(k => {
      const [y, m] = k.split('-');
      return `${y}/${parseInt(m)}`;
    });
    data = keys.map(k => counts[k]);
  }

  const ctx = document.getElementById('myChart').getContext('2d');
  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: '応募数',
        data,
        backgroundColor: data.map(v =>
          v > 0 && v === Math.max(...data)
            ? 'rgba(200, 82, 42, 0.85)'
            : 'rgba(200, 82, 42, 0.2)'
        ),
        borderColor: 'rgba(200, 82, 42, 0.5)',
        borderWidth: 1.5,
        borderRadius: 6,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1714',
          titleColor: '#f7f5f0',
          bodyColor: '#a09890',
          padding: 10,
          callbacks: { label: ctx => `  ${ctx.parsed.y} 件` }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          border: { display: false },
          ticks: {
            color: '#a09890',
            font: { size: 11, family: 'DM Mono' },
            maxTicksLimit: mode === 'daily' ? 10 : 12,
            maxRotation: 0,
          }
        },
        y: {
          grid: { color: 'rgba(226,221,212,0.6)' },
          border: { display: false },
          ticks: {
            color: '#a09890',
            font: { size: 11, family: 'DM Mono' },
            stepSize: 1,
          },
          beginAtZero: true,
        }
      }
    }
  });
}

async function loadData() {
  document.getElementById('chart-loading').style.display = 'flex';
  document.getElementById('myChart').style.display = 'none';
  document.getElementById('error-box').style.display = 'none';
  document.getElementById('last-updated').textContent = '取得中...';

  try {
    const pages = await fetchAllPages();
    allData = pages;
    renderStats(pages);
    renderChart(pages, currentTab);
    const now = new Date();
    document.getElementById('last-updated').textContent =
      `更新：${now.toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })}`;
  } catch (err) {
    document.getElementById('chart-loading').style.display = 'none';
    const eb = document.getElementById('error-box');
    eb.style.display = 'block';
    eb.textContent = `❌ エラー: ${err.message}`;
    document.getElementById('last-updated').textContent = '取得失敗';
  }
}

function switchTab(mode, btn) {
  currentTab = mode;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  if (allData.length > 0) renderChart(allData, mode);
}

loadData();
</script>
</body>
</html>
